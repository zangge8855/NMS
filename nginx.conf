# ============================
# Node Management System (NMS) Nginx 配置
# ============================
# 使用方法:
#   sudo cp nginx.conf /etc/nginx/sites-available/nms
#   sudo ln -sf /etc/nginx/sites-available/nms /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#
# 获取 SSL 证书 (Let's Encrypt):
#   sudo apt install certbot python3-certbot-nginx
#   sudo certbot --nginx -d your-domain.com
#   # Certbot 会自动修改此配置添加 SSL 配置
#   # 证书自动续期: sudo certbot renew --dry-run

# ── HTTP → HTTPS 重定向 ─────────────────────────────────
server {
    listen 80;
    server_name your-domain.com;  # ← 修改为你的域名

    # 用于 Let's Encrypt / Certbot 验证
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # 其余所有请求强制跳转 HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# ── HTTPS 主配置 ────────────────────────────────────────
server {
    listen 443 ssl http2;
    server_name your-domain.com;  # ← 修改为你的域名

    # SSL 证书路径 (Let's Encrypt 默认路径)
    ssl_certificate     /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # 前端静态文件
    location / {
        root /opt/nms/client/dist;
        try_files $uri $uri/ /index.html;

        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # API 代理到 Node.js 后端
    location /api/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # 限制请求体大小 (与 Express 一致)
        client_max_body_size 20m;
    }

    # ── 安全响应头 ──────────────────────────────────────
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none';" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

    # ── Gzip 压缩 ──────────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
    gzip_min_length 256;
}

# ── 仅 HTTP 模式 (开发/无域名场景) ────────────────────
# 如不使用 HTTPS，注释掉以上两个 server 块，取消以下注释:
#
# server {
#     listen 80;
#     server_name _;
#
#     location / {
#         root /opt/nms/client/dist;
#         try_files $uri $uri/ /index.html;
#     }
#
#     location /api/ {
#         proxy_pass http://127.0.0.1:3001;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#         proxy_read_timeout 300s;
#         proxy_send_timeout 300s;
#     }
#
#     add_header X-Frame-Options DENY;
#     add_header X-Content-Type-Options nosniff;
#     add_header X-XSS-Protection "1; mode=block";
#
#     gzip on;
#     gzip_types text/plain text/css application/json application/javascript text/xml;
#     gzip_min_length 256;
# }
